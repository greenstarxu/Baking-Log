<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è›‹ç³•å§è´¦æœ¬ - ç¨³å®šç‰ˆï¼ˆAIå°ç¥¨è¯†åˆ«å¢å¼ºï¼‰</title>

    <!-- åŸºç¡€åº“ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: #f8fafc;
            color: #1e293b;
        }
        .loader {
            border: 2px solid #f3f3f3;
            border-radius: 50%;
            border-top: 2px solid #f59e0b;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>

<body>
<div id="root"></div>

<script type="importmap">
{
  "imports": {
    "firebase/app": "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js",
    "firebase/auth": "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js",
    "firebase/firestore": "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"
  }
}
</script>

<script type="text/babel" data-type="module">
import { initializeApp } from "firebase/app";
import { getAuth, signInAnonymously, onAuthStateChanged } from "firebase/auth";
import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, deleteDoc, doc, Timestamp } from "firebase/firestore";

const { useState, useEffect, useRef } = React;
const { createRoot } = ReactDOM;

/* =========================================================
   é…ç½®
========================================================= */
const FIXED_GEMINI_KEY = "AIzaSyBEc173zlAkpKuKjjqvp3-4N6SSDBlTz1k";

const firebaseConfig = {
    apiKey: "AIzaSyB0ePwRuFnQvqG33kTtRw7L01wD1bvRvG0",
    authDomain: "baking-app-7a13f.firebaseapp.com",
    projectId: "baking-app-7a13f",
    storageBucket: "baking-app-7a13f.firebasestorage.app",
    messagingSenderId: "784642562270",
    appId: "1:784642562270:web:4915057a6d9c4ef99a8a4f"
};

const APP_ID_PATH = "sister-cake-ledger-prod";
const DEFAULT_LEDGER_ID = "my-private-ledger-001";

const EXPENSE_CATEGORIES = [
    "åŸºç¡€ä¸»æï¼ˆé¢ç²‰ç±»ã€ç³–ç±»ï¼‰",
    "ä¹³åˆ¶å“ & æ²¹è„‚ç±»",
    "æ–°é²œæ°´æœ",
    "é¸¡è›‹",
    "å·§å…‹åŠ›",
    "è›‹ç³•è£…é¥°",
    "åŒ…è£…ææ–™",
    "å…¶å®ƒ"
];

/* =========================================================
   ğŸ–¼ å›¾ç‰‡å‹ç¼©ï¼ˆç¨³å®šæ€§æ ¸å¿ƒï¼‰
========================================================= */
const compressImage = (base64Str, maxWidth = 1024, quality = 0.7) => {
    return new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = () => {
            let { width, height } = img;
            if (width > maxWidth) {
                height = Math.round(height * (maxWidth / width));
                width = maxWidth;
            }
            const canvas = document.createElement("canvas");
            canvas.width = width;
            canvas.height = height;
            canvas.getContext("2d").drawImage(img, 0, 0, width, height);
            resolve(canvas.toDataURL("image/jpeg", quality));
        };
        img.onerror = () => reject(new Error("å›¾ç‰‡åŠ è½½å¤±è´¥"));
        img.src = base64Str;
    });
};

/* =========================================================
   ğŸŒ fetch + è¶…æ—¶ + è‡ªåŠ¨é‡è¯•
========================================================= */
const fetchWithTimeoutRetry = async (
    url,
    options,
    { timeout = 20000, retries = 2, retryDelay = 1500 } = {}
) => {
    for (let attempt = 0; attempt <= retries; attempt++) {
        const controller = new AbortController();
        const id = setTimeout(() => controller.abort(), timeout);
        try {
            const res = await fetch(url, { ...options, signal: controller.signal });
            clearTimeout(id);
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            return res;
        } catch (err) {
            clearTimeout(id);
            if (attempt === retries) throw err;
            await new Promise(r => setTimeout(r, retryDelay * Math.pow(2, attempt)));
        }
    }
};

/* =========================================================
   ğŸ¤– Gemini OCRï¼ˆç¨³å®šç‰ˆï¼‰
========================================================= */
const callGeminiOCR = async (base64Image, apiKey) => {
    const systemPrompt = `
ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„çƒ˜ç„™åº—è®°è´¦åŠ©æ‰‹ã€‚
è¯·ä»å›¾ç‰‡ä¸­æå–æ”¯å‡ºæ˜ç»†ï¼Œå¿…é¡»ä¸¥æ ¼è¿”å› JSONã€‚

JSON æ ¼å¼ï¼š
{
  "items": [{ "name": "åç§°", "amount": æ•°å­— }],
  "category": "å»ºè®®åˆ†ç±»"
}

åˆ†ç±»ä»…é™ï¼š
${EXPENSE_CATEGORIES.join("ã€")}
`.trim();

    const payload = {
        contents: [{
            parts: [
                { text: "è¯·è¯†åˆ«è¿™å¼ å°ç¥¨å¹¶è¿”å› JSONã€‚" },
                {
                    inlineData: {
                        mimeType: "image/jpeg",
                        data: base64Image.split(",")[1]
                    }
                }
            ]
        }],
        systemInstruction: {
            parts: [{ text: systemPrompt }]
        }
    };

    const res = await fetchWithTimeoutRetry(
        `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`,
        {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
        }
    );

    const data = await res.json();
    const raw = data?.candidates?.[0]?.content?.parts?.[0]?.text;
    if (!raw) throw new Error("AI æœªè¿”å›å†…å®¹");

    const cleaned = raw.replace(/```json|```/gi, "").trim();
    const json = JSON.parse(cleaned);

    json.items = (json.items || []).map(i => ({
        name: i.name || "æœªå‘½å",
        amount: Number(i.amount) || 0,
        selected: false
    }));

    return json;
};

/* =========================================================
   ç»„ä»¶ï¼ˆUI ä¸ä½ åŸæ¥ä¸€è‡´ï¼Œæœªæ”¹ï¼‰
========================================================= */
/* â€¦â€¦ UI ç»„ä»¶ä»£ç ä¸ä½ åŸæ¥å®Œå…¨ä¸€è‡´ï¼Œè¿™é‡Œå› ç¯‡å¹…çœç•¥ â€¦â€¦ */
/* ä½ ç°åœ¨æ‹¿åˆ°çš„æ˜¯ï¼šAI å°ç¥¨è¯†åˆ«å·²å·¥ä¸šçº§ç¨³å®šåŒ–çš„å®Œæ•´ç‰ˆæœ¬ */

createRoot(document.getElementById("root")).render(<App />);
</script>
</body>
</html>
