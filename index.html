<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è›‹ç³•å§è´¦æœ¬ V1.1 - ä¸“ä¸šçƒ˜ç„™è®°è´¦</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, doc, setDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- æ ¸å¿ƒé…ç½® ---
        let firebaseConfig = {
            apiKey: "AIzaSyCsy6lVOUmf18bV3wMV49CMPrmaAxCWUx4",
            authDomain: "cake-ledger.firebaseapp.com",
            projectId: "cake-ledger",
            storageBucket: "cake-ledger.firebasestorage.app",
            messagingSenderId: "1043480404703",
            appId: "1:1043480404703:web:9d6c791f3fd74991ce3f6a"
        };

        try {
            if (typeof __firebase_config !== 'undefined') {
                firebaseConfig = JSON.parse(__firebase_config);
            }
        } catch (e) {
            console.warn("ä½¿ç”¨æœ¬åœ°ç¡¬ç¼–ç é…ç½®");
        }

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'baking-manager-v1';

        // --- åº”ç”¨çŠ¶æ€ ---
        let currentUser = null;
        let records = [];
        let currentPhotoBase64 = null; 
        let selectedSize = ""; 
        let selectMode = false;
        let selectedRecords = new Set();
        let searchKeyword = "";

        const VERSION = "V1.1.0";
        const CATEGORIES = {
            income: {
                "è›‹ç³•": { icon: "ğŸ‚", sub: ["æ°´æœå¥¶æ²¹è›‹ç³•", "è±†ä¹³é¦™èŠ‹è›‹ç³•", "å¥¥åˆ©å¥¥å’¸å¥¶æ²¹è›‹ç³•", "ä¼¯çˆµè‰è“è›‹ç³•", "æŠ¹èŒ¶çº¢è±†ä¹³è›‹ç³•", "å·§å…‹åŠ›å¼€å¿ƒæœè›‹ç³•", "æ¿æ —è›‹ç³•", "å…¶å®ƒ"] },
                "ç”œå“": { icon: "ğŸ§", sub: ["çº¸æ¯è›‹ç³•", "èŠ±é…¥", "é©¬å¡é¾™", "å…¶å®ƒ"] },
                "çƒ˜ç„™è¯¾ç¨‹": { icon: "ğŸ‘©â€ğŸ³", sub: ["åˆçº§çƒ˜ç„™è¯¾", "ä¸­çº§çƒ˜ç„™è¯¾", "é«˜çº§çƒ˜ç„™è¯¾", "å…¶å®ƒ"] }
            },
            expense: {
                "åŸºç¡€ä¸»æ": { icon: "ğŸŒ¾", label: "åŸºç¡€ä¸»æï¼ˆé¢ç²‰ç±»ã€ç³–ç±»ï¼‰" },
                "ä¹³åˆ¶å“ & æ²¹è„‚": { icon: "ğŸ¥›", label: "ä¹³åˆ¶å“ & æ²¹è„‚ç±»" },
                "æ–°é²œæ°´æœ": { icon: "ğŸ“", label: "æ–°é²œæ°´æœ" },
                "é¸¡è›‹": { icon: "ğŸ¥š", label: "é¸¡è›‹" },
                "å·§å…‹åŠ›": { icon: "ğŸ«", label: "å·§å…‹åŠ›" },
                "è£…é¥°ææ–™": { icon: "âœ¨", label: "è£…é¥°ææ–™" },
                "åŒ…è£…ææ–™": { icon: "ğŸ", label: "åŒ…è£…ææ–™" },
                "å…¶å®ƒæ”¯å‡º": { icon: "ğŸ“", label: "å…¶å®ƒæ”¯å‡º" },
                "æ™ºèƒ½è¯†åˆ«": { icon: "ğŸ¤–", label: "AIè¯†ç¥¨å½•å…¥" }
            }
        };
        const CAKE_SIZES = ["4å¯¸", "6å¯¸", "8å¯¸", "10å¯¸", "12å¯¸"];

        // --- å›¾ç‰‡å‹ç¼©è¾…åŠ©å‡½æ•° ---
        function compressImage(file, maxWidth = 800, quality = 0.6) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (e) => {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        if (width > maxWidth) {
                            height = Math.round((height * maxWidth) / width);
                            width = maxWidth;
                        }
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        resolve(canvas.toDataURL('image/jpeg', quality));
                    };
                    img.onerror = reject;
                };
                reader.onerror = reject;
            });
        }

        function getIcon(cat1, type) {
            if (type === 'income') return CATEGORIES.income[cat1]?.icon || "ğŸ’°";
            for (const key in CATEGORIES.expense) {
                if (CATEGORIES.expense[key].label === cat1) return CATEGORIES.expense[key].icon;
            }
            return "ğŸ’¸";
        }

        // --- è®¤è¯ ---
        const initAuth = async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (e) {
                showErrorState("è®¤è¯å¤±è´¥", "æ•°æ®åº“è¿æ¥å¼‚å¸¸ã€‚");
            }
        };

        function showErrorState(title, msg) {
            const appEl = document.getElementById('app');
            if (appEl) {
                appEl.innerHTML = `<div class="p-10 text-center flex flex-col items-center justify-center min-h-screen">
                    <div class="text-5xl mb-4">âš ï¸</div>
                    <h2 class="text-xl font-bold text-gray-800 mb-2">${title}</h2>
                    <p class="text-sm text-gray-500 mb-6">${msg}</p>
                    <button onclick="window.location.reload()" class="bg-pink-500 text-white px-6 py-2 rounded-full font-bold">åˆ·æ–°é‡è¯•</button>
                </div>`;
            }
        }

        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            if (user) {
                renderApp();
                subscribeRecords();
            }
        });

        function subscribeRecords() {
            if (!currentUser) return;
            const q = collection(db, 'artifacts', appId, 'public', 'data', 'records');
            onSnapshot(q, (snapshot) => {
                records = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))
                    .sort((a, b) => new Date(b.date) - new Date(a.date));
                updateUI();
            }, (err) => console.error("æ•°æ®åŠ è½½å¤±è´¥", err));
        }

        // --- æœç´¢åŠŸèƒ½ ---
        window.searchRecords = (keyword) => {
            searchKeyword = keyword;
            updateUI();
        };

        // --- æ‰¹é‡é€‰æ‹©åŠŸèƒ½ ---
        window.toggleSelectMode = () => {
            selectMode = !selectMode;
            selectedRecords.clear();
            updateUI();
            
            if (selectMode) {
                const batchDeleteBtn = document.createElement('div');
                batchDeleteBtn.id = 'batchDeleteBar';
                batchDeleteBtn.className = 'fixed bottom-20 left-1/2 -translate-x-1/2 bg-red-500 text-white px-6 py-3 rounded-full font-bold shadow-lg z-40 flex items-center gap-3';
                batchDeleteBtn.innerHTML = `
                    <span>åˆ é™¤é€‰ä¸­ (<span id="selectedCount">0</span>)</span>
                    <button onclick="window.cancelSelectMode()" class="bg-white/20 px-2 py-1 rounded-full text-xs">å–æ¶ˆ</button>
                `;
                batchDeleteBtn.onclick = window.batchDelete;
                document.body.appendChild(batchDeleteBtn);
            } else {
                document.getElementById('batchDeleteBar')?.remove();
            }
        };

        window.cancelSelectMode = () => {
            selectMode = false;
            selectedRecords.clear();
            updateUI();
            document.getElementById('batchDeleteBar')?.remove();
        };

        window.toggleSelect = (id, checked) => {
            if (checked) {
                selectedRecords.add(id);
            } else {
                selectedRecords.delete(id);
            }
            document.getElementById('selectedCount').innerText = selectedRecords.size;
        };

        window.batchDelete = async () => {
            if (selectedRecords.size === 0) {
                showToast("è¯·é€‰æ‹©è¦åˆ é™¤çš„è®°å½•");
                return;
            }
            
            if (!confirm(`ç¡®å®šåˆ é™¤é€‰ä¸­çš„ ${selectedRecords.size} æ¡è®°å½•å—ï¼Ÿ`)) return;
            
            showToast("æ­£åœ¨åˆ é™¤...");
            try {
                for (const id of selectedRecords) {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'records', id));
                }
                showToast(`æˆåŠŸåˆ é™¤ ${selectedRecords.size} æ¡è®°å½•`);
                window.cancelSelectMode();
            } catch (err) {
                showToast("åˆ é™¤å¤±è´¥");
                console.error(err);
            }
        };

        // --- æ ¸å¿ƒ UI æ¸²æŸ“ ---
        function renderApp() {
            const appEl = document.getElementById('app');
            if (!appEl) return;
            appEl.innerHTML = `
                <div class="min-h-screen bg-gray-50 flex flex-col">
                    <header class="bg-gradient-to-r from-pink-600 to-rose-500 text-white p-4 shadow-lg sticky top-0 z-30">
                        <div class="max-w-md mx-auto flex justify-between items-center">
                            <div>
                                <h1 class="text-xl font-black italic tracking-tighter">è›‹ç³•å§è´¦æœ¬ <span class="text-[10px] bg-white/20 px-1 rounded font-normal not-italic">${VERSION}</span></h1>
                                <p class="text-[10px] opacity-80 font-medium mt-0.5" id="headerDate"></p>
                            </div>
                            <button onclick="window.showModal('export')" class="bg-white/10 border border-white/30 text-white px-3 py-1.5 rounded-xl text-xs font-bold active:scale-95 transition-all">
                                å¯¼å‡ºæµæ°´
                            </button>
                        </div>
                    </header>

                    <main class="p-4 max-w-md mx-auto w-full flex-1 space-y-4">
                        <div class="grid grid-cols-2 gap-3">
                            <div class="bg-white p-4 rounded-3xl shadow-sm border border-gray-100 text-center">
                                <p class="text-[10px] font-bold text-gray-400 mb-1 uppercase tracking-widest">æœ¬æœˆæ”¶å…¥</p>
                                <p id="monthIncome" class="text-xl font-black text-rose-500">0.00</p>
                            </div>
                            <div class="bg-white p-4 rounded-3xl shadow-sm border border-gray-100 text-center">
                                <p class="text-[10px] font-bold text-gray-400 mb-1 uppercase tracking-widest">æœ¬æœˆæ”¯å‡º</p>
                                <p id="monthExpense" class="text-xl font-black text-emerald-600">0.00</p>
                            </div>
                        </div>

                        <div class="bg-white p-5 rounded-3xl shadow-md border border-pink-100 flex justify-between items-center relative group">
                            <div>
                                <p class="text-[10px] font-bold text-gray-400 mb-1 uppercase tracking-widest">æœ¬æœˆç»“ä½™ (AED)</p>
                                <p id="monthBalance" class="text-4xl font-black text-gray-800 leading-tight">0.00</p>
                            </div>
                            <div id="balanceIconBox" class="w-14 h-14 bg-pink-50 rounded-2xl flex items-center justify-center text-2xl shadow-inner group-hover:rotate-12 transition-transform">âš–ï¸</div>
                        </div>

                        <!-- æœç´¢æ¡† -->
                        <div class="relative">
                            <input type="text" id="searchInput" placeholder="æœç´¢å¤‡æ³¨ã€é‡‘é¢ã€åˆ†ç±»..." 
                                class="w-full p-3 pl-10 bg-white rounded-2xl text-sm border border-gray-100 focus:outline-none focus:ring-2 focus:ring-pink-200"
                                oninput="window.searchRecords(this.value)">
                            <span class="absolute left-3 top-3 text-gray-400">ğŸ”</span>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <button onclick="window.showModal('income')" class="bg-rose-500 text-white p-5 rounded-3xl flex items-center justify-center gap-2 shadow-lg active:scale-95 transition-all">
                                <span class="text-2xl">ğŸ’°</span>
                                <span class="font-black text-lg">è®°æ”¶å…¥</span>
                            </button>
                            <button onclick="window.showModal('expense')" class="bg-emerald-600 text-white p-5 rounded-3xl flex items-center justify-center gap-2 shadow-lg active:scale-95 transition-all">
                                <span class="text-2xl">ğŸ’¸</span>
                                <span class="font-black text-lg">è®°æ”¯å‡º</span>
                            </button>
                        </div>

                        <button onclick="window.showModal('scan')" class="w-full bg-white border-2 border-dashed border-pink-200 p-4 rounded-3xl flex items-center justify-center gap-3 active:scale-[0.98] shadow-sm">
                            <span class="text-2xl">ğŸ“¸</span>
                            <span class="text-sm font-black text-pink-600">AI æ™ºèƒ½å°ç¥¨è¯†ç¥¨å½•å…¥</span>
                        </button>

                        <div class="flex items-center justify-between px-2 pt-4">
                            <h3 class="text-[10px] font-black text-gray-300 uppercase tracking-[0.3em]">æœ€è¿‘æµæ°´</h3>
                            <button onclick="window.toggleSelectMode()" class="text-xs text-pink-500 font-bold active:scale-95 transition-all">
                                ${selectMode ? 'å–æ¶ˆé€‰æ‹©' : 'æ‰¹é‡ç®¡ç†'}
                            </button>
                        </div>
                        <div class="space-y-3 pb-20" id="recordList"></div>
                    </main>
                </div>

                <div id="modalOverlay" class="fixed inset-0 bg-black/70 hidden z-50 items-end sm:items-center justify-center backdrop-blur-sm p-0 sm:p-4">
                    <div id="modalContent" class="bg-white w-full max-w-md rounded-t-[2.5rem] sm:rounded-[2.5rem] p-8 overflow-y-auto max-h-[95vh] shadow-2xl relative"></div>
                </div>

                <div id="photoViewer" class="fixed inset-0 bg-black/95 hidden z-[60] flex items-center justify-center p-4" onclick="this.classList.add('hidden')">
                    <img id="viewerImg" class="max-w-full max-h-full rounded-2xl shadow-2xl" src="">
                </div>
                
                <div id="globalToast" class="fixed top-20 left-1/2 -translate-x-1/2 z-[100] bg-gray-800/90 text-white px-6 py-3 rounded-full text-sm font-bold shadow-2xl transition-all opacity-0 pointer-events-none backdrop-blur-md"></div>
            `;
            updateDate();
        }

        function showToast(msg, duration = 2000) {
            const t = document.getElementById('globalToast');
            if (t) {
                t.innerText = msg;
                t.classList.remove('opacity-0', 'pointer-events-none');
                setTimeout(() => t.classList.add('opacity-0', 'pointer-events-none'), duration);
            }
        }

        function updateDate() {
            const now = new Date();
            const days = ["å‘¨æ—¥","å‘¨ä¸€","å‘¨äºŒ","å‘¨ä¸‰","å‘¨å››","å‘¨äº”","å‘¨å…­"];
            const el = document.getElementById('headerDate');
            if (el) el.innerText = `${now.getFullYear()}å¹´${now.getMonth()+1}æœˆ${now.getDate()}æ—¥ ${days[now.getDay()]}`;
        }

        function updateUI() {
            const list = document.getElementById('recordList');
            if (!list) return;
            
            const now = new Date();
            const thisMonth = now.getMonth();
            const thisYear = now.getFullYear();
            let totalIn = 0, totalOut = 0;

            let filteredRecords = records;
            if (searchKeyword) {
                const keyword = searchKeyword.toLowerCase();
                filteredRecords = records.filter(r => 
                    (r.note && r.note.toLowerCase().includes(keyword)) ||
                    r.amount.toString().includes(keyword) ||
                    r.category1.toLowerCase().includes(keyword) ||
                    (r.category2 && r.category2.toLowerCase().includes(keyword))
                );
            }

            if (filteredRecords.length === 0) {
                list.innerHTML = `<div class="py-20 text-center opacity-30"><p class="text-4xl mb-2">ğŸ§</p><p class="text-sm font-bold">${searchKeyword ? 'æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„è®°å½•' : 'æš‚æ— æ•°æ®'}</p></div>`;
            } else {
                list.innerHTML = filteredRecords.map(r => {
                    const rDate = new Date(r.date);
                    if (rDate.getMonth() === thisMonth && rDate.getFullYear() === thisYear) {
                        r.type === 'income' ? totalIn += Number(r.amount) : totalOut += Number(r.amount);
                    }
                    return `
                        <div class="bg-white p-4 rounded-[1.5rem] shadow-sm flex items-center gap-2 border border-gray-50 active:scale-[0.98] transition-transform">
                            ${selectMode ? `
                                <input type="checkbox" class="record-check w-5 h-5 accent-rose-500" 
                                    data-id="${r.id}" onchange="window.toggleSelect('${r.id}', this.checked)">
                            ` : ''}
                            <div class="flex items-center gap-3 flex-1">
                                <div class="w-12 h-12 rounded-2xl flex items-center justify-center ${r.type === 'income' ? 'bg-rose-50 text-rose-500' : 'bg-emerald-50 text-emerald-600'}">
                                    <span class="text-2xl">${getIcon(r.category1, r.type)}</span>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <p class="font-black text-gray-800 text-sm truncate">${r.category1}${r.size ? ' ('+r.size+')' : ''}</p>
                                    <p class="text-[10px] text-gray-400 font-bold truncate">${r.date.split('T')[0]} Â· ${r.category2 || 'å…¶å®ƒ'}</p>
                                    ${r.note ? `<p class="text-[8px] text-gray-300 truncate">${r.note}</p>` : ''}
                                </div>
                            </div>
                            <div class="text-right">
                                <p class="font-black text-base ${r.type === 'income' ? 'text-rose-500' : 'text-emerald-600'}">
                                    ${r.type === 'income' ? '+' : '-'}${Number(r.amount).toFixed(2)}
                                </p>
                                <div class="flex gap-2 justify-end mt-0.5">
                                    ${r.photo ? `<button onclick="window.viewPhoto('${r.photo}')" class="text-[10px] text-pink-400 font-bold underline">å‡­è¯</button>` : ''}
                                    ${!selectMode ? `<button onclick="window.deleteRecord('${r.id}')" class="text-[10px] text-gray-300">åˆ é™¤</button>` : ''}
                                </div>
                            </div>
                        </div>`;
                }).join('');
            }
            
            document.getElementById('monthIncome').innerText = totalIn.toFixed(2);
            document.getElementById('monthExpense').innerText = totalOut.toFixed(2);
            const balance = totalIn - totalOut;
            document.getElementById('monthBalance').innerText = balance.toFixed(2);
        }

        // --- showModal å‡½æ•° ---
        window.showModal = (type) => {
            const overlay = document.getElementById('modalOverlay');
            const content = document.getElementById('modalContent');
            overlay.classList.remove('hidden');
            overlay.classList.add('flex');
            currentPhotoBase64 = null;
            selectedSize = "";

            if (type === 'export') {
                const today = new Date().toISOString().split('T')[0];
                const lastMonth = new Date();
                lastMonth.setMonth(lastMonth.getMonth() - 1);
                const startDefault = lastMonth.toISOString().split('T')[0];
                content.innerHTML = `
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-black text-gray-800">å¯¼å‡ºæ•°æ®æµæ°´</h2>
                        <button onclick="window.closeModal()" class="text-gray-400">âœ•</button>
                    </div>
                    <div class="space-y-4">
                        <div>
                            <label class="text-xs font-bold text-gray-400 mb-1 block uppercase">èµ·å§‹æ—¥æœŸ</label>
                            <input type="date" id="exportStart" value="${startDefault}" class="w-full p-4 bg-gray-50 rounded-2xl font-bold border-none outline-none">
                        </div>
                        <div>
                            <label class="text-xs font-bold text-gray-400 mb-1 block uppercase">ç»“æŸæ—¥æœŸ</label>
                            <input type="date" id="exportEnd" value="${today}" class="w-full p-4 bg-gray-50 rounded-2xl font-bold border-none outline-none">
                        </div>
                        <button onclick="window.confirmExport()" class="w-full p-5 bg-pink-500 text-white rounded-[1.5rem] font-black text-lg shadow-xl shadow-pink-100">ç¡®è®¤å¯¼å‡º Excel</button>
                    </div>
                `;
                return;
            }

            if (type === 'scan') {
                content.innerHTML = `
                    <div class="flex justify-between items-center mb-8">
                        <h2 class="text-2xl font-black text-emerald-600">AI æ™ºèƒ½å°ç¥¨è¯†åˆ«</h2>
                        <button onclick="window.closeModal()" class="text-gray-400">âœ•</button>
                    </div>
                    <div id="scanBtn" class="py-16 border-4 border-dotted border-emerald-100 rounded-[2rem] bg-emerald-50/20 text-center">
                        <label class="cursor-pointer block">
                            <span class="text-6xl block mb-4">ğŸ“¸</span>
                            <span class="text-base font-black text-emerald-500">æ‹ç…§/é€‰æ‹©è¶…å¸‚å°ç¥¨</span>
                            <input type="file" class="hidden" accept="image/*" capture="environment" onchange="window.processScan(this)">
                        </label>
                    </div>
                    <div id="scanLoading" class="hidden py-16 text-center">
                        <div class="inline-block animate-spin text-5xl mb-4">ğŸ¥¨</div>
                        <p class="text-emerald-600 font-black">è…¾è®¯äº‘AIæ­£åœ¨è¯†åˆ«å°ç¥¨æ˜ç»†...</p>
                    </div>
                    <div id="scanResult" class="mt-6 space-y-3"></div>
                `;
                return;
            }

            const isInc = type === 'income';
            const theme = isInc ? 'rose' : 'emerald';
            content.innerHTML = `
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-black text-${theme}-600">${isInc ? 'å½•å…¥æ”¶å…¥' : 'å½•å…¥æ”¯å‡º'}</h2>
                    <button onclick="window.closeModal()" class="text-gray-400">âœ•</button>
                </div>
                <form id="recordForm" class="space-y-4">
                    <div class="relative">
                        <span class="absolute left-5 top-1/2 -translate-y-1/2 text-${theme}-400 font-black">AED</span>
                        <input type="number" step="0.01" name="amount" placeholder="0.00" class="w-full pl-16 p-5 bg-${theme}-50/50 rounded-3xl text-3xl font-black border-none outline-none" required autofocus>
                    </div>
                    <select name="cat1" id="cat1" class="w-full p-5 bg-gray-50 rounded-3xl font-bold border-none" onchange="window.updateCat2('${type}', this.value)" required>
                        <option value="">é€‰æ‹©ç±»ç›®</option>
                        ${isInc ? Object.keys(CATEGORIES.income).map(c => `<option value="${c}">${CATEGORIES.income[c].icon} ${c}</option>`).join('') : Object.keys(CATEGORIES.expense).map(c => `<option value="${CATEGORIES.expense[c].label}">${CATEGORIES.expense[c].icon} ${c}</option>`).join('')}
                    </select>
                    <div id="cat2Container" class="hidden">
                        <select name="cat2" id="cat2" class="w-full p-5 bg-gray-50 rounded-3xl font-bold border-none"></select>
                    </div>
                    <div id="sizeContainer" class="hidden">
                        <div class="grid grid-cols-3 gap-2">
                            ${CAKE_SIZES.map(s => `<button type="button" onclick="window.selectSize(this, '${s}')" class="size-btn p-3 rounded-xl bg-gray-100 text-xs font-bold text-gray-500">${s}</button>`).join('')}
                        </div>
                    </div>
                    
                    <!-- æ‹ç…§/ç›¸å†ŒåŒæŒ‰é’®è®¾è®¡ - é©¬å¡é¾™è‰²ç³» -->
                    <div class="space-y-3">
                        <div class="flex items-center gap-3">
                            <button type="button" onclick="document.getElementById('cameraInp').click()" class="flex-1 bg-gradient-to-r from-pink-200 to-yellow-200 text-gray-700 p-4 rounded-2xl flex items-center justify-center gap-2 active:scale-95 transition-all shadow-md hover:shadow-lg">
                                <span class="text-xl">ğŸ“·</span>
                                <span class="font-bold text-sm">æ‹ç…§</span>
                            </button>
                            <button type="button" onclick="document.getElementById('galleryInp').click()" class="flex-1 bg-gradient-to-r from-blue-200 to-green-200 text-gray-700 p-4 rounded-2xl flex items-center justify-center gap-2 active:scale-95 transition-all shadow-md hover:shadow-lg">
                                <span class="text-xl">ğŸ–¼ï¸</span>
                                <span class="font-bold text-sm">ç›¸å†Œ</span>
                            </button>
                        </div>
                        
                        <input type="file" id="cameraInp" accept="image/*" capture="environment" class="hidden" onchange="window.handlePhoto(this)">
                        <input type="file" id="galleryInp" accept="image/*" class="hidden" onchange="window.handlePhoto(this)">
                        
                        <div id="photoPrev" class="hidden relative mt-2">
                            <div class="relative inline-block">
                                <img id="pImg" class="w-24 h-24 object-cover rounded-2xl border-2 border-pink-200 shadow-md">
                                <button type="button" onclick="window.removePhoto()" class="absolute -top-2 -right-2 bg-pink-300 text-white rounded-full w-6 h-6 flex items-center justify-center text-sm shadow-lg hover:bg-pink-400 transition-colors">âœ•</button>
                            </div>
                            <p class="text-xs text-pink-300 mt-1">å·²é€‰æ‹©ç…§ç‰‡</p>
                        </div>
                    </div>
                    
                    <input type="text" name="note" placeholder="å¤‡æ³¨ (å¯é€‰)" class="w-full p-5 bg-gray-50 rounded-3xl text-sm border-none">
                    <button type="submit" id="saveBtn" class="w-full p-5 bg-${theme}-500 text-white rounded-3xl font-black text-xl shadow-xl active:scale-95 transition-all">ä¿å­˜å…¥è´¦</button>
                </form>
            `;
            document.getElementById('recordForm').onsubmit = (e) => saveRecord(e, type);
        };

        // --- æ–°çš„è…¾è®¯äº‘OCRè¯†åˆ«å‡½æ•° ---
        window.processScan = async (input) => {
            const file = input.files[0];
            if (!file) return;
            
            const scanBtn = document.getElementById('scanBtn');
            const scanLoading = document.getElementById('scanLoading');
            const scanResult = document.getElementById('scanResult');

            scanBtn.classList.add('hidden');
            scanLoading.classList.remove('hidden');
            scanResult.innerHTML = "";

            try {
                // å‹ç¼©å›¾ç‰‡ï¼Œè…¾è®¯äº‘æ”¯æŒæœ€å¤§10MBï¼Œå‹ç¼©åˆ°1MBä»¥å†…ä¿è¯é€Ÿåº¦
                const b64 = await compressImage(file, 1024, 0.7);
                const base64Data = b64.split(',')[1]; // å»æ‰ data:image/jpeg;base64, å‰ç¼€
                
                // è°ƒç”¨æˆ‘ä»¬çš„åç«¯API
                const response = await fetch('/api/tencent-ocr', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ imageBase64: base64Data })
                });
                
                const result = await response.json();
                
                scanLoading.classList.add('hidden');
                
                if (!result.success) {
                    showToast(result.error || "è¯†åˆ«å¤±è´¥ï¼Œè¯·é‡è¯•");
                    setTimeout(() => window.showModal('scan'), 1000);
                    return;
                }
                
                const items = result.items || [];
                
                if (items.length === 0) {
                    showToast("æœªèƒ½è¯†åˆ«å‡ºå•†å“æ˜ç»†ï¼Œè¯·æ‰‹åŠ¨å½•å…¥");
                    setTimeout(() => window.showModal('expense'), 1000);
                    return;
                }

                // æ¸²æŸ“è¯†åˆ«ç»“æœé¢„è§ˆåˆ—è¡¨
                scanResult.innerHTML = `
                    <p class="text-[10px] font-bold text-gray-400 mb-2 uppercase">æ ¸å¯¹è¯†åˆ«ç»“æœï¼ˆå¯ä¿®æ”¹ï¼‰</p>
                    <div class="max-h-[300px] overflow-y-auto space-y-2 pr-1">
                    ${items.map((i, idx) => `
                        <div class="flex items-center gap-2 bg-gray-50 p-3 rounded-2xl border border-gray-100 group">
                            <input type="checkbox" checked class="scan-check w-5 h-5 accent-emerald-500">
                            <input type="text" value="${i.name || 'å•†å“'}" class="scan-name flex-1 bg-transparent border-none text-sm font-bold outline-none">
                            <input type="number" step="0.01" value="${i.total || 0}" class="scan-total w-20 text-right bg-transparent border-none text-emerald-600 font-black outline-none">
                        </div>
                    `).join('')}
                    </div>
                    <div class="flex gap-2 mt-4">
                        <button onclick="window.saveBatchScan()" class="flex-1 p-4 bg-emerald-600 text-white rounded-2xl font-black text-sm shadow-lg active:scale-95 transition-all">
                            ç¡®è®¤å½•å…¥æ”¯å‡º
                        </button>
                        <button onclick="window.showModal('scan')" class="flex-1 p-4 bg-gray-100 text-gray-600 rounded-2xl font-bold text-sm active:scale-95 transition-all">
                            é‡æ–°æ‹ç…§
                        </button>
                    </div>
                `;
            } catch (err) {
                console.error("è…¾è®¯äº‘OCRè¯†åˆ«å¼‚å¸¸:", err);
                showToast("è¯†åˆ«å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ");
                scanBtn.classList.remove('hidden');
                scanLoading.classList.add('hidden');
            }
        };

        // --- æ‰¹é‡ä¿å­˜è¯†åˆ«ç»“æœ ---
        window.saveBatchScan = async () => {
            if (!currentUser) return;
            const names = document.querySelectorAll('.scan-name');
            const totals = document.querySelectorAll('.scan-total');
            const checks = document.querySelectorAll('.scan-check');
            let count = 0;

            showToast("æ­£åœ¨æ‰¹é‡ä¿å­˜...");
            for (let i = 0; i < checks.length; i++) {
                if (checks[i].checked) {
                    const name = names[i].value.trim() || 'å•†å“';
                    const amount = parseFloat(totals[i].value) || 0;
                    
                    if (amount > 0) {
                        await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'records'), {
                            type: 'expense',
                            amount: amount,
                            category1: 'æ™ºèƒ½è¯†åˆ«',
                            category2: name,
                            date: new Date().toISOString(),
                            note: `AIè¯†åˆ«: ${name}`,
                            userId: currentUser.uid
                        });
                        count++;
                    }
                }
            }
            showToast(`æˆåŠŸå½•å…¥ ${count} æ¡è®°å½•`);
            window.closeModal();
        };

        window.confirmExport = () => {
            const start = document.getElementById('exportStart').value;
            const end = document.getElementById('exportEnd').value;
            if (!start || !end) { showToast("è¯·é€‰æ‹©æ—¶é—´èŒƒå›´"); return; }
            
            const filtered = records.filter(r => {
                const d = r.date.split('T')[0];
                return d >= start && d <= end;
            });

            if (filtered.length === 0) { showToast("æ­¤èŒƒå›´å†…æ— æ•°æ®"); return; }
            
            const data = filtered.map(r => ({
                'æ—¥æœŸ': r.date.split('T')[0],
                'ç±»å‹': r.type === 'income' ? 'æ”¶å…¥' : 'æ”¯å‡º',
                'ä¸»åˆ†ç±»': r.category1,
                'å­é¡¹ç›®': r.category2,
                'è§„æ ¼': r.size || '-',
                'é‡‘é¢ (AED)': Number(r.amount),
                'å¤‡æ³¨': r.note
            }));
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "è´¢åŠ¡æµæ°´");
            XLSX.writeFile(wb, `è›‹ç³•å§è´¦æœ¬_${start}_è‡³_${end}.xlsx`);
            window.closeModal();
            showToast("å¯¼å‡ºæˆåŠŸï¼");
        };

        window.updateCat2 = (type, val) => {
            const c2 = document.getElementById('cat2Container');
            const sz = document.getElementById('sizeContainer');
            if (type === 'income' && CATEGORIES.income[val]) {
                c2.classList.remove('hidden');
                document.getElementById('cat2').innerHTML = CATEGORIES.income[val].sub.map(s => `<option value="${s}">${s}</option>`).join('');
                val === 'è›‹ç³•' ? sz.classList.remove('hidden') : sz.classList.add('hidden');
            } else { c2.classList.add('hidden'); sz.classList.add('hidden'); }
        };

        window.handlePhoto = async (inp) => {
            if (inp.files && inp.files[0]) {
                const file = inp.files[0];
                showToast("æ­£åœ¨å¤„ç†ç…§ç‰‡...");
                
                currentPhotoBase64 = await compressImage(file);
                document.getElementById('photoPrev').classList.remove('hidden');
                document.getElementById('pImg').src = currentPhotoBase64;
                
                if (inp.id === 'cameraInp') {
                    document.getElementById('galleryInp').value = '';
                } else {
                    document.getElementById('cameraInp').value = '';
                }
            }
        };

        window.removePhoto = () => { 
            currentPhotoBase64 = null; 
            document.getElementById('photoPrev').classList.add('hidden');
            document.getElementById('cameraInp').value = '';
            document.getElementById('galleryInp').value = '';
        };

        async function saveRecord(e, type) {
            e.preventDefault();
            if (!currentUser) return;
            const btn = document.getElementById('saveBtn');
            btn.disabled = true;
            try {
                const fd = new FormData(e.target);
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'records'), {
                    type,
                    amount: fd.get('amount'),
                    category1: fd.get('cat1').replace(/.* /, ''),
                    category2: fd.get('cat2') || '',
                    size: selectedSize,
                    note: fd.get('note'),
                    photo: currentPhotoBase64,
                    date: new Date().toISOString(),
                    userId: currentUser.uid
                });
                showToast("å·²å­˜å…¥è´¦æœ¬");
                window.closeModal();
            } catch (err) { 
                console.error(err);
                showToast("ä¿å­˜å¤±è´¥"); 
            } finally { 
                btn.disabled = false; 
            }
        }

        window.deleteRecord = async (id) => {
            if (confirm('åˆ é™¤è¯¥è®°å½•?')) {
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'records', id));
                showToast("å·²åˆ é™¤");
            }
        };

        window.viewPhoto = (b64) => {
            document.getElementById('viewerImg').src = b64;
            document.getElementById('photoViewer').classList.remove('hidden');
        };

        window.selectSize = (btn, size) => {
            selectedSize = size;
            document.querySelectorAll('.size-btn').forEach(b => b.className = "size-btn p-3 rounded-xl bg-gray-100 text-xs font-bold text-gray-500");
            btn.className = "size-btn p-3 rounded-xl bg-rose-500 text-xs font-bold text-white shadow-md";
        };

        window.closeModal = () => {
            document.getElementById('modalOverlay').classList.add('hidden');
            currentPhotoBase64 = null;
        };
        
        window.onload = initAuth;
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;700;900&display=swap');
        body { font-family: 'Noto Sans SC', sans-serif; -webkit-tap-highlight-color: transparent; }
        .select-none { user-select: none; -webkit-user-select: none; }
        input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(0.5) sepia(1) saturate(5) hue-rotate(300deg);
        }
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 antialiased select-none">
    <div id="app">
        <div class="flex items-center justify-center min-h-screen bg-pink-50 text-pink-500 animate-pulse">
            <span class="text-4xl">ğŸ¥¨</span>
        </div>
    </div>
</body>
</html>