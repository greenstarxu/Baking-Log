<!--
  蛋糕姐账本 V1.2
  Upgrade: AI识票增强 + 性能优化 + 整包稳定版
-->
<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>蛋糕姐账本 V1.2</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script type="module">
/* ================= Firebase ================= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import {
  getFirestore, collection, addDoc, onSnapshot,
  deleteDoc, doc
} from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

/* =============== Config ==================== */
const firebaseConfig = {
  apiKey: "AIzaSyCsy6lVOUmf18bV3wMV49CMPrmaAxCWUx4",
  authDomain: "cake-ledger.firebaseapp.com",
  projectId: "cake-ledger",
  storageBucket: "cake-ledger.firebasestorage.app",
  messagingSenderId: "1043480404703",
  appId: "1:1043480404703:web:9d6c791f3fd74991ce3f6a"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = "baking-manager-v1";
const apiKey = firebaseConfig.apiKey;

/* =============== State ===================== */
let currentUser = null;
let records = [];
let renderLimit = 50;        // V1.2 性能：分页渲染
let searchKeyword = "";
let debounceTimer = null;

/* =============== Utils ===================== */
function debounceRender(fn, delay = 300) {
  clearTimeout(debounceTimer);
  debounceTimer = setTimeout(fn, delay);
}

function compressImage(file, maxWidth = 1024, quality = 0.7) {
  return new Promise(resolve => {
    const r = new FileReader();
    r.onload = e => {
      const img = new Image();
      img.onload = () => {
        const c = document.createElement("canvas");
        let w = img.width, h = img.height;
        if (w > maxWidth) {
          h = h * maxWidth / w;
          w = maxWidth;
        }
        c.width = w; c.height = h;
        c.getContext("2d").drawImage(img, 0, 0, w, h);
        resolve(c.toDataURL("image/jpeg", quality));
      };
      img.src = e.target.result;
    };
    r.readAsDataURL(file);
  });
}

/* =============== Auth ====================== */
signInAnonymously(auth);
onAuthStateChanged(auth, user => {
  if (!user) return;
  currentUser = user;
  subscribe();
});

/* =============== Firestore ================= */
function subscribe() {
  const q = collection(db, "artifacts", appId, "public", "data", "records");
  onSnapshot(q, snap => {
    records = snap.docs.map(d => ({ id: d.id, ...d.data() }))
      .sort((a,b)=> new Date(b.date)-new Date(a.date));
    debounceRender(renderList);
  });
}

/* =============== Render ==================== */
window.searchRecords = v => {
  searchKeyword = v.toLowerCase();
  renderLimit = 50;
  renderList();
};

function renderList() {
  const list = document.getElementById("recordList");
  if (!list) return;

  let data = records;
  if (searchKeyword) {
    data = data.filter(r =>
      r.note?.toLowerCase().includes(searchKeyword) ||
      r.category1?.toLowerCase().includes(searchKeyword) ||
      r.category2?.toLowerCase().includes(searchKeyword) ||
      String(r.amount).includes(searchKeyword)
    );
  }

  const slice = data.slice(0, renderLimit);
  list.innerHTML = slice.map(r => `
    <div class="bg-white p-4 rounded-2xl flex justify-between items-center">
      <div>
        <div class="font-bold text-sm">${r.category1}</div>
        <div class="text-[10px] text-gray-400">${r.category2 || ""}</div>
      </div>
      <div class="text-right">
        <div class="${r.type==='income'?'text-rose-500':'text-emerald-600'} font-black">
          ${r.type==='income'?'+':'-'}${Number(r.amount).toFixed(2)}
        </div>
        ${r.photo ? `<button onclick="viewPhoto('${r.photo}')" class="text-xs text-pink-400">凭证</button>` : ``}
      </div>
    </div>
  `).join("");

  if (data.length > renderLimit) {
    list.innerHTML += `
      <button onclick="loadMore()" class="w-full py-3 text-xs text-gray-400">
        加载更多…
      </button>`;
  }
}

window.loadMore = () => {
  renderLimit += 50;
  renderList();
};

/* =============== AI Scan V1.2 ================= */
window.processScan = async inp => {
  const file = inp.files[0];
  if (!file) return;

  const b64 = await compressImage(file);
  const base64 = b64.split(",")[1];

  const prompt = `
你是专业财务记账AI。
任务：
1. 识别小票中所有商品
2. 自动合并同名商品
3. 使用“最终实付价”
4. 返回 JSON 数组，不要任何解释

格式：
[
  { "name": "商品名", "total": 12.5, "confidence": "high|low" }
]
`;

  const res = await fetch(
    \`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=\${apiKey}\`,
    {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        contents: [{
          parts: [
            { text: prompt },
            { inlineData: { mimeType: "image/jpeg", data: base64 } }
          ]
        }],
        generationConfig: { responseMimeType: "application/json" }
      })
    }
  );

  const json = await res.json();
  let text = json.candidates?.[0]?.content?.parts?.[0]?.text || "[]";

  let items = [];
  try {
    items = JSON.parse(text);
  } catch {
    const m = text.match(/\[.*\]/s);
    if (m) items = JSON.parse(m[0]);
  }

  if (!items.length) {
    alert("识别不稳定，已切换为手动支出录入");
    return;
  }

  for (const i of items) {
    await addDoc(collection(db,"artifacts",appId,"public","data","records"),{
      type:"expense",
      amount:i.total,
      category1:"智能识别",
      category2:i.name,
      date:new Date().toISOString(),
      userId:currentUser.uid
    });
  }

  alert(`成功录入 ${items.length} 条`);
};

/* =============== Photo ==================== */
window.viewPhoto = b64 => {
  const v = document.getElementById("viewer");
  document.getElementById("viewerImg").src = b64;
  v.classList.remove("hidden");
};
</script>

<style>
body { font-family: "Noto Sans SC", sans-serif; }
</style>
</head>

<body class="bg-gray-100">
<div class="max-w-md mx-auto p-4">
  <input placeholder="搜索…" oninput="searchRecords(this.value)"
    class="w-full mb-3 p-3 rounded-xl" />
  <div id="recordList" class="space-y-3"></div>
</div>

<div id="viewer" class="fixed inset-0 bg-black/90 hidden flex items-center justify-center" onclick="this.classList.add('hidden')">
  <img id="viewerImg" class="max-w-full max-h-full rounded-xl" />
</div>
</body>
</html>
